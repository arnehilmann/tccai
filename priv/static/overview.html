<table id="resources"><thead/><tbody/></table>

<table id="units"><thead/><tbody/></table>




<script src="js/d3.js" charset="utf-8"></script>

<script>
    "use strict";

    // taken from http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
    }

    var load_units = () =>
        d3.json("/units", units => {
            //console.log(units);
            var table = d3.select("#units");

            var thead = table.select("thead");
            thead.selectAll("tr").data([1]).enter().append('tr')
                .selectAll('th')
                .data(["unit id", "name", "human name", "health", "max health"]).enter()
                .append('th')
                .text(d => d);

            var tbody = table.select("tbody").selectAll("tr").data(units, unit => unit.id);
            tbody.enter().append("tr");

            var values = tbody.selectAll("td")
                .data(unit => [unit.id, unit.name, unit.human_name, unit.health.toFixed(0), unit.max_health.toFixed(0)]);
            values.enter().append("td");

            values.text(d => d);

            values.exit().remove();
            tbody.exit().remove();
        });

    var load_economy = () =>
        d3.json("/resources", resources => {
            // console.log(resources);
            var table = d3.select("#resources");

            var thead = table.select("thead");
            thead.selectAll("tr").data([1]).enter().append('tr')
                .selectAll('th')
                .data(["resource", "current", "max", "+", "-", "(+)"]).enter()
                .append('th')
                .text(d => d);

            var tbody = table.select("tbody").selectAll("tr").data(resources, resource => resource.id);
            tbody.enter().append("tr");

            var values = tbody.selectAll("td")
                .data(r => [r.name, r.current.toFixed(0), r.storage.toFixed(0), r.income.toFixed(0), r.usage.toFixed(0), r.excess.toFixed(0)]);
            values.enter().append("td");
            values.text(d => d);
            values.exit().remove();
            tbody.exit().remove();
        });

    var reload = () => {
        load_units();
        load_economy();
        var delay_in_seconds = parseInt(getURLParameter("delay"));
        if (delay_in_seconds) {
            setTimeout(reload, delay_in_seconds * 1000);
        }
    };

    reload();
</script>
